```{r, echo = FALSE}
title <- "Exploratory analysis"
```

---
title: `r title`
author: "Steffan Noe Niikanoff Christiansen"
output: html_document
---


### Global options and paths
```{r libraries, echo = FALSE, message=FALSE}
packages <- c("tidyverse", "patchwork", "kableExtra", "noecodedup", "here", "sesame", "RColorBrewer")

invisible(lapply(packages, require, character.only = TRUE)) 
theme_set(theme_bw() + 
            theme(plot.title = element_text(hjust = 0.5)))
```

```{r setup, message=FALSE, echo = FALSE}
# paths
root_path <- here()
projects_path <- str_remove(root_path, "/[A-z]+$")
fig_path <- here("results", "images", title, "/")
anno_path <- here(projects_path, "array_annotation", "data", "epic.2.0", "zhou_annotation")

# global options
require("knitr")
opts_knit$set(root.dir = root_path)
opts_chunk$set(warning = TRUE,
               message = FALSE,
               dpi = 300,
               dev = "jpeg",
               fig.width = 6,
               fig.height = 6,
               fig.align="center", 
               fig.path = fig_path,
               echo = FALSE,
               warning = FALSE)

selected_theme <- theme(axis.text.y = element_text(size = 14),
      axis.text.x = element_text(size = 14),
      axis.title.y = element_text(size = 16),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 14),
      strip.text = element_text(size = 12))

options(scipen = 100, digits = 3, bitmapType = "cairo") # fixes grid.Call warning 
time <- lubridate::date()
```
Rendering of the report was started `r time` <br> Following packages
were loaded: `r packages` <br><br>


### Data
```{r Data}
M_values_combat <- readRDS("results/processed/m_values_combat_2024_06_27.rds")
sample_sheet <- readRDS("data/sample_sheet_2024_10_23.rds")
selected_colors <- readRDS("data/selected_colors_2023_12_19.rds")

M_values_combat <- M_values_combat[rowSums(is.na(M_values_combat)) == 0, ]
all_probes <- rownames(M_values_combat)
```
Values were available from `r ncol(M_values_combat)` samples and `r nrow(M_values_combat)` probes (probes with NA-values excluded).

```{r colors for plotting}
id_vec <- sample_sheet %>% 
  distinct(id) %>% 
  arrange(id) %>% 
  pull()

replacement_names <- setNames(paste0("#", seq(1:length(id_vec))), id_vec)

sample_sheet %>%
  mutate(new_names = str_replace_all(id, replacement_names)) %>% 
  count(new_names, id) %>% 
  arrange(id) %>% 
  s_table()
```
<br><br>

### Sample information
```{r, eval = FALSE}
sample_sheet <- readRDS("data/sample_sheet_2023_12_19.rds")
sample_sheet <- sample_sheet %>% 
  mutate(id_2 = str_extract(sample_name, "[0-9]+"))

fn = "sample_information_2.xlsx"

col_names <- readxl::read_xlsx(here("data", fn)) %>% 
  s_names %>% 
  names

sample_info_2 <- bind_rows(
  readxl::read_xlsx(here("data", fn), col_names = FALSE, n_max = 2, skip = 2),
  readxl::read_xlsx(here("data", fn), col_names = FALSE, skip = 7)
) 
colnames(sample_info_2) <- col_names

sample_info_2 <- sample_info_2 %>% 
  mutate(id_2 = str_extract(samples, "[0-9]+"),
         id_2 = if_else(nchar(id_2) == 2, paste0(0, id_2), id_2),
         hw_perc_of_bw = heart_weight/1000/body_weight*100) %>% 
  filter(id_2 %in% sample_sheet$id_2)

sample_sheet <- left_join(
  sample_sheet,
  sample_info_2 %>% 
    dplyr::select(-c(age, sex)), 
  by = c("id_2"))

saveRDS(sample_sheet, "data/sample_sheet_2024_10_23.rds")
```

```{r }
sample_sheet %>% 
  select(id, sex) %>% 
  distinct() %>% 
  count(sex) %>% 
  s_table

sample_sheet %>% 
  distinct(id, decomposition) %>% 
  count(decomposition) %>% 
  s_table

sample_characteristics <- sample_sheet %>% 
  distinct(id, sex, age) %>% 
  arrange(age) %>% 
  mutate(age_int = cut_width(age, 5, boundary = 25),
         xmin = c(seq(1,15)),
         xmax = c(seq(1,15)+0.8),
         ymin = c(rep(0, 15)),
         ymax = c(rep(0.8, 15)))
```

```{r Sample summary, fig.width = 10, fig.height = 6, out.width = "100%", eval = FALSE}
p1 <- sample_characteristics %>% 
  mutate(age_int = str_replace_all(age_int, 
                                   c("," = "-",
                                     "\\(" = "",
                                     "]" = "",
                                     "\\[" = ""))) %>% 
  ggplot() +
  geom_rect(aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = age_int), color = "black") + 
  scale_fill_manual(values = RColorBrewer::brewer.pal(9, "YlOrRd")[seq(1,9,2)]) + 
  labs(fill = "Age of death (years)",
       y = "Age of death")

p2 <- sample_characteristics %>% 
  ggplot() +
  geom_rect(aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = sex), color = "black") + 
  scale_fill_manual(values = selected_colors$sex) +
  labs(y = "Sex",
       fill = "Sex")

p3 <- sample_sheet %>% 
  distinct(origin) %>% 
  ggplot() +
  geom_rect(aes(xmin = 0, xmax = 1, ymin = 0, ymax = 1, fill = origin), color = "black") +
  scale_fill_manual(values = selected_colors$origin) +
  labs(x = expression(paste(beta, "-value")),
       fill = "Origin")

p1 + p2 + plot_layout(ncol = 1, guides = "collect") & theme(
  panel.border = element_blank(),
  panel.background = element_blank(),   # Remove background color
  panel.grid = element_blank(),         # Remove grid lines
  axis.text = element_blank(),          # Remove axis text
  axis.ticks = element_blank(),         # Remove axis ticks
  # axis.title = element_blank(),         # Remove axis titles
  plot.background = element_blank()
) &
  coord_fixed()
p3
```
<br>

```{r}
sample_sheet %>% 
  select(id, age) %>% 
  distinct() %>% 
  summarise(min = min(age),
            median = median(age),
            max = max(age)) %>% 
  s_table
```
The sample sheet contain information of `r length(unique(sample_sheet$id))` individuals. <br><br>

#### Cardiac measures
```{r, fig.width = 10, fig.height = 6, out.width = "80%"}
t1 <- sample_sheet %>% 
  dplyr::select(body_height, body_weight, heart_weight, hw_perc_of_bw) %>% 
  reframe(across(
    everything(), 
    list(
      mean = ~ mean(.),
      median = ~ median(.),
      range = ~ diff(range(.)),
      sd = ~ sd(.)),
    .names = "{.col}-{.fn}"
  ))

t1 %>%
  pivot_longer(cols = everything(), 
               names_to = c("column", "stat"), 
               names_sep = "-") %>%
  pivot_wider(names_from = stat, values_from = value) %>%
  mutate(relative_sd = sd/mean*100) %>% 
  s_table()
```

#### Weight
```{r Weight, fig.width = 6, fig.height = 6, out.width = "80%"}
t3 <- sample_sheet %>% 
  dplyr::select(id, heart_weight, hw_perc_of_bw) %>% 
  distinct() %>% 
  pivot_longer(cols = c(heart_weight, hw_perc_of_bw), names_to = "measure")

t3 %>% 
  ggplot(., aes(x = measure, y = value)) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(aes(color = id), width = 0.05, size = 2) +
  facet_wrap(~measure, scales = "free") +
  scale_color_manual(values = selected_colors$id)

```
<br><br>

### Positions for filtering
```{r Positions for filtering, fig.width = 10, fig.height = 6, out.width = "100%"}
chr_order <- c(paste("chr", 1:22, sep=""), "chrX", "chrY", "chrM", "chr22_KI270879v1_alt")

manifest <- read_tsv(here(anno_path, "EPICv2.hg38.manifest.gencode.v41.tsv.gz")) %>% 
  s_names %>% 
  mutate(cpg_chrm = factor(cpg_chrm, levels = chr_order),
         prefix = str_extract(probeid, "[a-z]+")) %>% 
  arrange(cpg_chrm, cpg_beg)

manifest_filt <- manifest %>%
  filter(probeid %in% all_probes) %>%
  filter(!cpg_chrm %in% c("chrX", "chrY", "chrM", "chr22_KI270879v1_alt")) %>% 
  filter(!prefix %in% c("ctl", "nv", "rs")) 
```

The different probe prefixes of the filtered manifest are shown below:
```{r , fig.width = 10, fig.height = 6, out.width = "100%"}
manifest_filt %>%
  count(prefix) %>% 
  s_table
```
<br>

```{r}
rm(manifest)
```
<br><br>

### Principal component analysis (PCA)
```{r sample and NA removal of beta_values}
M_values_combat <- M_values_combat[!rowSums(!is.finite(M_values_combat)),]
M_values_combat <- M_values_combat[rowSums(is.na(M_values_combat)) == 0, ]
```
There are `r nrow(M_values_combat)` in the matrix after sample removal and removal of probes with NA and Inf values.

```{r }
M_values_combat[1:3, 1:4] %>% s_table()
```
The M-value object is constituted by `r nrow(M_values_combat)` rows and `r ncol(M_values_combat)` columns.

```{r}
M_values_combat <- M_values_combat[, !colSums(!is.finite(M_values_combat))]
```
After removal of values that are not finite, `r ncol(M_values_combat)` columns are remaining. <br>


#### Scree plots
prcomp function is used for the calculation of the principal components with the following inputs `center = TRUE, scale = TRUE`. 
```{r M prin comp}
prin_comp_M_combat <- prcomp(t(M_values_combat), center = TRUE, scale = TRUE) 
PCA_var_M_combat <- prin_comp_M_combat$sdev^2 # squared standard deviation (in M-values)
PCA_var_perc_M_combat <- round(PCA_var_M_combat/sum(PCA_var_M_combat)*100, 2) # percentage of variation explained by each PC
scree_data_M_combat <- data.frame(PCA_var_perc = PCA_var_perc_M_combat, 
                           "PC" = rep(1:length(PCA_var_perc_M_combat)))
```

```{r Scree plots, fig.height=5, fig.width=8, fig.align="center"}
scree_data_M_combat %>% 
  ggplot(., aes(y = PCA_var_perc, x = PC)) +
  geom_bar(stat = "identity") +
    theme(plot.title = element_text(hjust = 0.5)) +
    xlab("Principal Component") +
    ylab("Percent Variation")
```
<br><br>

```{r}
prin_comp_M_combat_df <- as.data.frame(prin_comp_M_combat$x)
prin_comp_M_combat_df <- rownames_to_column(prin_comp_M_combat_df, "id_pos") %>%
  left_join(., sample_sheet)
```

#### PCA plots
```{r}
plot_PCA <- function(input_df, PC_x, PC_y, group_variable){
  input_df %>%
    ggplot(., aes(x = get(PC_x),
                  y = get(PC_y),
                  color = get(group_variable))) +
    geom_point(size = 3) +
    theme_bw()  
}
```
<br>

```{r PCA ID, fig.height=10, fig.width=5}
p_PCA_M_combat_1 <- plot_PCA(prin_comp_M_combat_df, "PC1", "PC2", 'id') +
  scale_color_manual(values = selected_colors$id) +
  labs(color = 'ID',
       x = paste0("PC1 ", "(", scree_data_M_combat[1, "PCA_var_perc"], "%)"),
       y = paste0("PC2 ", "(", scree_data_M_combat[2, "PCA_var_perc"], "%)"))

p_PCA_M_combat_2 <- plot_PCA(prin_comp_M_combat_df, "PC3", "PC4", 'id') +
  scale_color_manual(values = selected_colors$id) +
  labs(color = 'ID',
       x = paste0("PC3 ", "(", scree_data_M_combat[3, "PCA_var_perc"], "%)"),
       y = paste0("PC4 ", "(", scree_data_M_combat[4, "PCA_var_perc"], "%)"))

# p_PCA_M_combat_1 + p_PCA_M_combat_2 + plot_annotation(title = "Colored by ID") +
#   plot_layout(guides = "collect", ncol = 2)

p_PCA_M_combat_1 + p_PCA_M_combat_2 + plot_annotation(title = "Colored by ID") +
  plot_layout(guides = "collect", ncol = 1)
```
<br> 

```{r PCA ID 2, fig.height=8, fig.width=4}
p_PCA_M_combat_1 + p_PCA_M_combat_2 + plot_annotation(title = "Colored by ID") +
  plot_layout(guides = "collect", ncol = 1)
```
<br> 

```{r PCA sex, fig.height=5, fig.width=10}
p_PCA_M_combat_1 <- plot_PCA(prin_comp_M_combat_df, "PC1", "PC2", 'sex') +
  scale_color_manual(values = selected_colors$sex) +
  labs(color = 'sex',
       x = paste0("PC1 ", "(", scree_data_M_combat[1, "PCA_var_perc"], "%)"),
       y = paste0("PC2 ", "(", scree_data_M_combat[2, "PCA_var_perc"], "%)"))

p_PCA_M_combat_2 <- plot_PCA(prin_comp_M_combat_df, "PC3", "PC4", 'sex') +
  scale_color_manual(values = selected_colors$sex) +
  labs(color = 'sex',
       x = paste0("PC3 ", "(", scree_data_M_combat[3, "PCA_var_perc"], "%)"),
       y = paste0("PC4 ", "(", scree_data_M_combat[4, "PCA_var_perc"], "%)"))

p_PCA_M_combat_1 + p_PCA_M_combat_2 + plot_annotation(title = "Colored by sex") +
  plot_layout(guide = "collect", ncol = 2)
```
<br>

```{r PCA origin, fig.height=5, fig.width=10}
p_PCA_M_combat_1 <- plot_PCA(prin_comp_M_combat_df, "PC1", "PC2", 'origin') +
  scale_color_manual(values = selected_colors$origin) +
  labs(color = 'origin',
       x = paste0("PC1 ", "(", scree_data_M_combat[1, "PCA_var_perc"], "%)"),
       y = paste0("PC2 ", "(", scree_data_M_combat[2, "PCA_var_perc"], "%)"))

p_PCA_M_combat_2 <- plot_PCA(prin_comp_M_combat_df, "PC3", "PC4", 'origin') +
  scale_color_manual(values = selected_colors$origin) +
  labs(color = 'origin',
       x = paste0("PC3 ", "(", scree_data_M_combat[3, "PCA_var_perc"], "%)"),
       y = paste0("PC4 ", "(", scree_data_M_combat[4, "PCA_var_perc"], "%)"))

# p_PCA_M_combat_1 + p_PCA_M_combat_2 + plot_annotation(title = "Colored by origin") +
#   plot_layout(guide = "collect", ncol = 2)

p_PCA_M_combat_1 + p_PCA_M_combat_2 + plot_annotation(title = "Colored by origin") +
  plot_layout(guides = "collect", ncol = 1) & labs(color = "Origin") & selected_theme
```
<br> 

```{r PCA origin 2, fig.height=8, fig.width=4}
p_PCA_M_combat_1 + p_PCA_M_combat_2 + plot_annotation(title = "Colored by origin") +
  plot_layout(guides = "collect", ncol = 1) & labs(color = "Origin") & selected_theme
```
<br> 

```{r PCA age, fig.height=5, fig.width=10}
p_PCA_M_combat_1 <- plot_PCA(prin_comp_M_combat_df, "PC1", "PC2", 'age') + labs(color = 'age',
       x = paste0("PC1 ", "(", scree_data_M_combat[1, "PCA_var_perc"], "%)"),
       y = paste0("PC2 ", "(", scree_data_M_combat[2, "PCA_var_perc"], "%)"))

p_PCA_M_combat_2 <- plot_PCA(prin_comp_M_combat_df, "PC3", "PC4", 'age') +
  labs(color = 'age',
       x = paste0("PC3 ", "(", scree_data_M_combat[3, "PCA_var_perc"], "%)"),
       y = paste0("PC4 ", "(", scree_data_M_combat[4, "PCA_var_perc"], "%)"))

p_PCA_M_combat_1 + p_PCA_M_combat_2 + plot_annotation(title = "Colored by age") +
  plot_layout(guide = "collect", ncol = 2)
```
<br>

```{r PCA sentrix_id, fig.height=5, fig.width=10}
p_PCA_M_combat_1 <- plot_PCA(prin_comp_M_combat_df, "PC1", "PC2", 'sentrix_id') +
  labs(color = 'sentrix_id',
       x = paste0("PC1 ", "(", scree_data_M_combat[1, "PCA_var_perc"], "%)"),
       y = paste0("PC2 ", "(", scree_data_M_combat[2, "PCA_var_perc"], "%)"))

p_PCA_M_combat_2 <- plot_PCA(prin_comp_M_combat_df, "PC3", "PC4", 'sentrix_id') +
  labs(color = 'sentrix_id',
       x = paste0("PC3 ", "(", scree_data_M_combat[3, "PCA_var_perc"], "%)"),
       y = paste0("PC4 ", "(", scree_data_M_combat[4, "PCA_var_perc"], "%)"))

p_PCA_M_combat_1 + p_PCA_M_combat_2 + plot_annotation(title = "Colored by sentrix_id") +
  plot_layout(guide = "collect", ncol = 2)
```
<br>

```{r PCA sentrix_position, fig.height=5, fig.width=10}
p_PCA_M_combat_1 <- plot_PCA(prin_comp_M_combat_df, "PC1", "PC2", 'sentrix_position') +
  labs(color = 'sentrix_position',
       x = paste0("PC1 ", "(", scree_data_M_combat[1, "PCA_var_perc"], "%)"),
       y = paste0("PC2 ", "(", scree_data_M_combat[2, "PCA_var_perc"], "%)"))

p_PCA_M_combat_2 <- plot_PCA(prin_comp_M_combat_df, "PC3", "PC4", 'sentrix_position') +
  labs(color = 'sentrix_position',
       x = paste0("PC3 ", "(", scree_data_M_combat[3, "PCA_var_perc"], "%)"),
       y = paste0("PC4 ", "(", scree_data_M_combat[4, "PCA_var_perc"], "%)"))

p_PCA_M_combat_1 + p_PCA_M_combat_2 + plot_annotation(title = "Colored by sentrix_position") +
  plot_layout(guide = "collect", ncol = 2)
```
Notice that R01C08 samples form a separate "group" in left part of the figure. <br>
<br><br>

### Variability among positions
```{r}
# Function to calculate RSD
calculate_rsd <- function(x) {
  sd_value <- sd(x)
  mean_value <- abs(mean(x))
  rsd <- (sd_value / mean_value)
  return(rsd)
}
```
The relative standard deviation is calculated as indicated: $RSD = \frac{SD}{|mean(methylation-value)|}$. Notice that the absolute value is used in the denominator. The coefficient of variation (CV) should be calculated with the true value in the dominator according to [RG post](https://www.researchgate.net/post/RSD_vs_CV#:~:text=From%20a%20conceptual%20point%20of,some%20case%20could%20be%20negative). <br>

#### Beta-values - SD vs RSD
```{r}
test_matrix <- cbind("cg_1" = c(0.05, 0.05, 0.1, 0.1), 
                     "cg_2" = c(0.25, 0.25, 0.3, 0.3),
                     "cg_3" = c(0.90, 0.90, 0.95, 0.95))
rownames(test_matrix) <- paste0("id_", seq(1:4))

test_matrix %>% 
  s_table()
```
The variability measures per position are shown below:

```{r}
rbind("SD" = apply(test_matrix, 2, sd),
      "RSD" = apply(test_matrix, 2, calculate_rsd)) %>% 
  s_table()
```
<br>
  
```{r}
beta_values_combat <- readRDS("results/processed/beta_values_combat_2024_06_27.rds")
beta_values_combat <- beta_values_combat[rownames(M_values_combat), ]
```
`beta_values_combat_2024_06_27.rds` is used as `beta_values_combat` input. 

```{r eval=TRUE}
saveRDS(beta_values_combat, "results/processed/beta_values_combat_filtered_2024_06_27.rds")
```

```{r}
beta_val_rsd <- apply(beta_values_combat, 1, calculate_rsd)
beta_val_sd <- apply(beta_values_combat, 1, sd) 
beta_val_mean <- apply(beta_values_combat, 1, mean) 
# "1" indicates that SD is calculated for each row corresponding to each probe. 

# identical(beta_val_rsd %>% names, beta_val_sd %>% names)
# identical(beta_val_rsd %>% names, beta_val_mean %>% names)

beta_val_measusures <- data.frame(
  rsd = beta_val_rsd, 
  sd = beta_val_sd,
  mean = beta_val_mean) %>% 
  rownames_to_column(., "name")
```

```{r beta-value mean vs variability, fig.width = 10, fig.height = 5, out.width = "100%"}
p1 <- beta_val_measusures %>% 
  ggplot(aes(x = mean, y = sd)) +
  geom_bin2d(bins = 500) +
  scale_fill_gradient(trans = "log2", limits = c(1, 4096)) +
  labs(title = "beta-value (SD)")

p2 <- beta_val_measusures %>% 
  ggplot(aes(x = mean, y = rsd)) +
  geom_bin2d(bins = 500) +
  scale_fill_gradient(trans = "log2", limits = c(1, 4096)) +
  labs(title = "beta-value (RSD)")

p1 + p2 + plot_layout(ncol = 2, guide = "collect")
```
<br><br>


#### M-values - SD vs RSD
```{r}
test_matrix <- BetaValueToMValue(test_matrix)

test_matrix %>% 
  s_table()
```
The variability measures per position are shown below:

```{r}
rbind("SD" = apply(test_matrix, 2, sd),
      "RSD" = apply(test_matrix, 2, calculate_rsd)) %>% 
  s_table()
```
<br>

```{r}
# M_values_combat <- BetaValueToMValue(beta_values_combat)
M_val_rsd <- apply(M_values_combat, 1, calculate_rsd)
M_val_sd <- apply(M_values_combat, 1, sd) 
M_val_mean <- apply(M_values_combat, 1, mean) 
# "1" indicates that SD is calculated for each row corresponding to each probe. 

# identical(M_val_rsd %>% names, M_val_sd %>% names)
# identical(M_val_rsd %>% names, M_val_mean %>% names)

M_val_measusures <- data.frame(
  rsd = M_val_rsd, 
  sd = M_val_sd,
  mean = M_val_mean) %>% 
  rownames_to_column(., "name")
```

```{r M-value mean vs variability, fig.width = 10, fig.height = 5, out.width = "100%"}
p1 <- M_val_measusures %>% 
  ggplot(aes(x = mean, y = sd)) +
  geom_bin2d(bins = 500) +
  scale_fill_gradient(limits = c(1, 250)) +
  labs(title = "M-value (SD)")

p2 <- M_val_measusures %>% 
  ggplot(aes(x = mean, y = rsd)) +
  geom_bin2d(bins = 500) +
  scale_fill_gradient(limits = c(1, 250)) +
  scale_y_continuous(trans = "log2") +
  labs(title = "M-value (RSD)")

p1 + p2 + plot_layout(ncol = 2, guide = "collect")
```
<br> 

#### Distribution of M-value SD
```{r Distribution of M-value SD, fig.width = 10, fig.height = 6, out.width = "80%"}
M_val_measusures %>% 
  ggplot(aes(x = sd)) +
  geom_histogram(color = "black",
                 fill = "white",
                 binwidth = 0.1,
                 boundary = 0) + 
  theme(axis.text.x = element_text(angle = 45,
                                   margin = margin(4, 0, 0, 0),
                                   hjust = 0.95)) +
  scale_x_continuous(breaks = seq(0, 4, by = .5)) + 
  labs(x = "M-value SD") 
```
In total, `r nrow(M_val_measusures)` M-value measures are available. <br><br>

#### Pearson's correlation (squared) of beta-values
```{r Pearsons correlation (squared) of beta-values, fig.width = 8, fig.height = 8, out.width = "100%"}
identical(sample_sheet$id_pos, colnames(beta_values_combat))

order <- sample_sheet %>% 
  arrange(id, origin) %>%
  pull(id_pos)

cor_mat <- cor(as.data.frame(beta_values_combat)[, order], method = "pearson")
cor_mat[lower.tri(cor_mat)] <- NA
cor_mat <- cor_mat^2

melted_cor_mat <- reshape2::melt(cor_mat, na.rm = TRUE)

replacement_names <- setNames(as.character(sample_sheet$id), 
                              as.character(sample_sheet$id_pos))

replacement_names_id_origin <- setNames(
  paste0(
    as.character(sample_sheet$id), "_",
    as.character(sample_sheet$origin)),
  as.character(sample_sheet$id_pos))

melted_cor_mat <- melted_cor_mat %>% 
  mutate(id_var1 = str_replace_all(Var1, replacement_names),
         id_var2 = str_replace_all(Var2, replacement_names))

limits <- c(0.95, 1)
p1 <- melted_cor_mat %>% 
  ggplot(., aes(Var2, Var1, fill = value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "grey", high = "#08306B",
                       midpoint = limits[1]/limits[2],
                       limit = limits, space = "Lab",
                       name = bquote(~R^2)) + 
  scale_x_discrete(labels = replacement_names_id_origin) + 
  scale_y_discrete(labels = replacement_names_id_origin) + 
  theme(axis.text.x = element_text(angle = 45,
                                   margin = margin(4, 0, 0, 0),
                                   hjust = 1)) + 
  coord_fixed() +
  labs(y = "",
       x = "")

p1 
# p1 + theme(
#   axis.text.x = element_text(size = 6),
#   axis.text.y = element_text(size = 6)
#   )
# 
# p1 + theme(
#   axis.text.x = element_text(size = 8),
#   axis.text.y = element_text(size = 8)
#   )
# 
# p1 + theme(
#   axis.text.x = element_text(size = 10),
#   axis.text.y = element_text(size = 10)
#   )
# 
# p1 + theme(
#   axis.text.x = element_text(size = 12),
#   axis.text.y = element_text(size = 12)
#   )
```
<br>

The min, median and max among all values are shown below:
```{r , fig.width = 8, fig.height = 8, out.width = "100%"}
melted_cor_mat_tib <- melted_cor_mat %>% 
  as_tibble()

cor_among_all <- melted_cor_mat_tib %>% 
  filter(Var1 != Var2) %>% 
  reframe(min_cor = min(value), 
          median_cor = median(value), 
          max_cor = max(value))
s_table(cor_among_all)
```

The min, median and max per individual are shown below:
```{r fig.width = 8, fig.height = 8, out.width = "100%"}
id_order <- paste0("#",seq(1:15))

cor_per_ind <- melted_cor_mat_tib %>% 
  filter(Var1 != Var2) %>% 
  filter(id_var1 == id_var2) %>%
  group_by(id_var1) %>% 
  reframe(min_cor = min(value), 
          median_cor = median(value), 
          max_cor = max(value)) %>% 
  mutate(id_order = match(id_var1, id_order)) %>% 
  arrange(id_order)

s_table(cor_per_ind)
```
Median of medians is `r median(cor_per_ind$median_cor)`. The median R2 ranged from `r min(cor_per_ind$median_cor)` to `r max(cor_per_ind$median_cor)`. 
<br><br>

#### Sample distances among M-values
```{r Sample distances among M-values, fig.width = 7, fig.height = 8, out.width = "100%"}
sampleDists <- dist(t(M_values_combat)) # samples as rows
sampleDistMatrix <- as.matrix(sampleDists) 

rownames(sampleDistMatrix) <- paste0(sample_sheet$id, "_", sample_sheet$origin)
colnames(sampleDistMatrix) <- paste0(sample_sheet$id, "_", sample_sheet$origin)
colors <- colorRampPalette(rev(brewer.pal(9, "Blues")))(255) 
pheatmap::pheatmap(sampleDistMatrix, 
         clustering_distance_rows = sampleDists, 
         clustering_distance_cols = sampleDists, col=colors,
         fontsize_row = 6,
         fontsize_col = 6)
```
Sample distances were calculated using the `euclidean` distance measure. High similarity is indicated by short distances (distance = 0 within the same samples).

<br><br>

### Heatmap of most variable positions
As suggested by [Du et al (2010)](https://bmcbioinformatics.biomedcentral.com/articles/10.1186/1471-2105-11-587), M-values are ued to identify most variable positions. Due to the relatively linar relation ship between mean and SD, SD are used for filtering. The visualisation are conducted using $Beta-values$. <br>
 
Similarity is measured using Euclidian distance with complete linkage clustering. Default for pheatmap package.

```{r Heatmap of most variable positions, fig.width = 6, fig.height = 4, out.width = "100%"}
# threshold_vec <- c(1, 1.25, 1.5, 1.75, 2)
threshold_vec <- c(1)

for (sd_threshold in threshold_vec) {
  beta_values_above_threshold <- M_val_measusures %>%
    filter(sd >= sd_threshold) %>%
    pull(name)
  
  beta_value_subset <- beta_values_combat[beta_values_above_threshold, ]
  
  column_annotations <- sample_sheet %>%
    select(id, sex, origin) %>% as.data.frame
  rownames(column_annotations) <- colnames(beta_value_subset)
  print(identical(sample_sheet$id_pos, colnames(beta_values_combat)))
  
  pheatmap::pheatmap(beta_value_subset,
                     main = paste0("All positions with M-value SD above ", sd_threshold, 
                                  " (n = ", nrow(beta_value_subset), ")"),
                     show_rownames = if_else(nrow(beta_value_subset) > 10, FALSE, TRUE),
                     # show_rownames = TRUE,
                     annotation_colors = selected_colors,
                     annotation_col = column_annotations,
                     labels_col = rep("", ncol(beta_value_subset)),
                     clustering_distance_rows = "euclidean",
                     clustering_distance_cols = "euclidean",
                     clustering_method = "complete")
  cat("\n\n")
}

n_probes <- nrow(M_val_measusures)
n_top_01percent <- n_probes/1000 %>% as.integer()

beta_values_above_threshold <- M_val_measusures %>%
  arrange(-sd) %>% 
  slice(1:n_top_01percent) %>% 
  pull(name)

beta_value_subset <- beta_values_combat[beta_values_above_threshold, ]

column_annotations <- sample_sheet %>%
  select(id, sex, origin) %>% as.data.frame
rownames(column_annotations) <- colnames(beta_value_subset)
print(identical(sample_sheet$id_pos, colnames(beta_values_combat)))

pheatmap::pheatmap(beta_value_subset,
                   main = paste0("One per thousand with highest variability", 
                                 " (n = ", nrow(beta_value_subset), ")"),
                   show_rownames = if_else(nrow(beta_value_subset) > 10, FALSE, TRUE),
                   # show_rownames = TRUE,
                   annotation_colors = selected_colors,
                   annotation_col = column_annotations,
                   labels_col = rep("", ncol(beta_value_subset)),
                   clustering_distance_rows = "euclidean",
                   clustering_distance_cols = "euclidean",
                   clustering_method = "complete")
cat("\n\n")
```

The 10 most variable positions are shown below:
```{r}
M_val_measusures %>% 
  dplyr::slice_max(sd, n = 10) %>% 
  s_table()
```

```{r, eval = TRUE}
M_values_combat_tidy <- M_values_combat %>%
  as.data.frame() %>% 
  rownames_to_column(., "probe_ID") %>% 
  gather(key = sample_name,
         value = m_value,
         2:length(.))

colnames(M_values_combat_tidy)[2] <- "id_pos"

M_values_combat_tidy <- M_values_combat_tidy %>%
  left_join(., sample_sheet, by = "id_pos") %>%
  as_tibble()

saveRDS(M_val_measusures, "results/processed/m_value_measures_combat_variation_2024_06_27.rds")
saveRDS(M_values_combat, "results/processed/m_values_combat_filtered_2024_06_27.rds")
saveRDS(M_values_combat_tidy, "results/processed/m_values_combat_tidy_2024_06_27.rds")
```

Dimensions of objects: <br> 
  
  * `M_val_measusures`: `r dim(M_val_measusures)`
  * `M_values_combat`: `r dim(M_values_combat)`
  * `M_values_combat_tidy`: `r dim(M_values_combat_tidy)`

```{r}
rm(M_values, M_val_measusures, M_values_combat_tidy)
```
<br><br>


#### Beta-value distributions
```{r tidy beta values, eval = TRUE}
identical(sample_sheet$id_pos,
          colnames(beta_values_combat))

beta_values_combat <- beta_values_combat[rowSums(is.na(beta_values_combat)) == 0, ]

beta_values_combat_tidy <- beta_values_combat %>%
  as.data.frame() %>% 
  rownames_to_column(., "probe_ID") %>% 
  gather(key = sample_name,
         value = beta_value,
         2:length(.))

colnames(beta_values_combat_tidy)[2] <- "id_pos"

beta_values_combat_tidy <- beta_values_combat_tidy %>%
  left_join(., sample_sheet, by = "id_pos") %>% 
  as_tibble()

saveRDS(beta_values_combat_tidy, "results/processed/beta_values_combat_tidy_2024_06_27.rds")
```

```{r eval = TRUE}
beta_values_combat_tidy <- readRDS("results/processed/beta_values_combat_tidy_2024_06_27.rds")
```
`r nrow(beta_values_combat_tidy)/45` positions in `beta_values_combat_tidy_2024_06_27.rds` object. 

```{r}
calculate_peak_distance <- function(values) {
  density_data <- density(values)
  density_df <- data.frame(x = density_data$x, y = density_data$y)
  
  # Identify the peaks
  peaks <- pracma::findpeaks(density_df$y, sortstr = TRUE)
  peak_positions <- density_df$x[peaks[, 2]]
  
  # Calculate the distance between the two highest peaks
  peak_distance <- abs(diff(sort(peak_positions, decreasing = TRUE)[1:2]))
  return(peak_distance)
}

peak_distance_df <- beta_values_combat_tidy %>%
  select(beta_value, id_pos, sentrix_id, sentrix_position) %>% 
  group_by(sentrix_id, sentrix_position) %>% 
  summarise(peak_distance = calculate_peak_distance(beta_value))  
```
peak distances were calculated with the `pracma` package. <br> 

##### Sentrix positions
```{r Beta-value distribution by position, fig.width = 10, fig.height = 8}
# beta_values_combat_tidy <- beta_values_combat_tidy %>%
#   group_by(sample_name) %>%
#   slice(1:1000)

beta_values_combat_tidy %>% 
  ggplot(., aes(x = beta_value, color = sentrix_position)) +
  geom_density(linewidth = 1) +
  facet_wrap(~ sentrix_id, ncol = 3) +
  labs(y = "Density",
       color = "Sentrix Positions", 
       x = expression(paste(beta, "-value")))
```

Quantiles are shown below:
```{r}
beta_values_combat_tidy %>% 
  group_by(sentrix_position) %>% 
  drop_na %>% 
  summarise(quant_0.10 = quantile(beta_value, 0.10),
            quant_0.25 = quantile(beta_value, 0.25),
            quant_0.50 = quantile(beta_value, 0.50),
            quant_0.75 = quantile(beta_value, 0.75),
            quant_0.90 = quantile(beta_value, 0.90)) %>% 
  s_table()
```
Notice that R01C01 samples have a larger dynamic range than the remaining samples. quant_0.10 and quant_0.90 are lowest and highest, respectively. Median value is furthermore 0.025 higher than second-highest median value. <br><br>

Median peak distances (calculated with pracma::findpeaks) are shown below:
```{r}
t1 <- peak_distance_df %>% 
  group_by(sentrix_position) %>% 
  reframe(median_peak_distance_sen_pos = median(peak_distance)) 

t1 %>% 
  s_table()
```
The difference between the two lowest and highest value is `r max(t1$median_peak_distance_sen_pos)-min(t1$median_peak_distance_sen_pos)`

<br><br>

##### Sentrix ID
```{r Beta-value distribution by sentrix_id, fig.width = 10, fig.height = 8}
beta_values_combat_tidy %>% 
  ggplot(., aes(x = beta_value, color = sentrix_id)) +
  geom_density(linewidth = 0.75) +
  facet_wrap(~ sentrix_position, ncol = 4) +
  labs(y = "Density",
       color = "Sentrix ID",
       x = expression(paste(beta, "-value")))
```

Quantiles are shown below:
```{r}
beta_values_combat_tidy %>% 
  group_by(sentrix_id) %>% 
  drop_na %>% 
  summarise(quant_0.10 = quantile(beta_value, 0.10),
            quant_0.25 = quantile(beta_value, 0.25),
            quant_0.50 = quantile(beta_value, 0.50),
            quant_0.75 = quantile(beta_value, 0.75),
            quant_0.90 = quantile(beta_value, 0.90)) %>% 
  s_table()
```
<br><br>

Median peak distances (calculated with pracma::findpeaks) are shown below:
```{r}
t2 <- peak_distance_df %>% 
  group_by(sentrix_id) %>% 
  reframe(median_peak_distance_sen_id = median(peak_distance)) 

t2 %>% 
  s_table()
```
The difference between the two lowest and highest value is `r max(t2$median_peak_distance_sen_id)-min(t2$median_peak_distance_sen_id)`
<br><br>
  
##### ID
```{r Beta-value distribution by id, fig.width = 10, fig.height = 6}
beta_values_combat_tidy %>% 
  ggplot(., aes(x = beta_value, color = id)) +
  geom_density(linewidth = 0.5) +
  facet_wrap(~ origin, ncol = 3) + 
  theme(plot.margin = unit(c(2, 0.2, 0.2, 0.5), "cm"))+
  labs(y = "Density",
       color = "ID",
       x = expression(paste(beta, "-value")))
```

Quantiles are shown below:
```{r}
beta_values_combat_tidy %>% 
  group_by(id) %>% 
  drop_na %>% 
  summarise(quant_0.10 = quantile(beta_value, 0.10),
            quant_0.25 = quantile(beta_value, 0.25),
            quant_0.50 = quantile(beta_value, 0.50),
            quant_0.75 = quantile(beta_value, 0.75),
            quant_0.90 = quantile(beta_value, 0.90)) %>% 
  s_table()
```
<br><br>


Dimensions of beta-value objects: <br> 
  
  * `beta_values_combat`: `r dim(beta_values_combat)`
  * `beta_values_combat_tidy`: `r dim(beta_values_combat_tidy)`


<br><br>

------------------------------------------------------------------------
```{r computetime, echo=FALSE}
time <- lubridate::date()
```
Report was knitted `r time` <br>


```{r}
sessionInfo()
```


```{r rendering while keeping objects in global environment, echo = FALSE, eval=FALSE}
rmarkdown::render("scripts/exploratory_analysis.Rmd", clean = TRUE, output_dir = "reports/")
```
<br>
